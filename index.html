<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="X Card Maker">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <meta name="description" content="Create beautiful X/Twitter card images with AI translation">
  
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  
  <title>X Card Maker</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: white; overscroll-behavior: none; }
    body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
    #root { min-height: 100vh; min-height: 100dvh; }
    .install-banner { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #1d4ed8, #7c3aed); padding: 16px 24px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 1000; display: flex; align-items: center; gap: 16px; max-width: calc(100% - 32px); animation: slideUp 0.4s ease-out; }
    .install-banner.hidden { display: none; }
    @keyframes slideUp { from { transform: translateX(-50%) translateY(100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
    .ios-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; }
    .ios-modal.hidden { display: none; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: flex; align-items: center; justify-content: center; }
    .loading-spinner { width: 48px; height: 48px; border: 4px solid #333; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tab-content { animation: fadeSlide 0.2s ease-out; }
    @keyframes fadeSlide { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <div id="install-banner" class="install-banner hidden">
    <div style="flex:1">
      <div style="font-weight:700;font-size:15px;">ğŸ“² å®‰è£ X Card Maker</div>
      <div style="font-size:13px;color:#cbd5e1;margin-top:2px;">ä¸€éµå®‰è£åˆ°ä¸»ç•«é¢</div>
    </div>
    <button id="install-btn" class="bg-white text-blue-600 font-bold px-4 py-2 rounded-lg">å®‰è£</button>
    <button id="install-close" class="text-white/70 px-2">âœ•</button>
  </div>

  <div id="ios-modal" class="ios-modal hidden">
    <div class="bg-zinc-900 p-8 rounded-2xl max-w-xs text-center border border-zinc-800">
      <h3 class="text-xl font-bold mb-4">ğŸ“² å®‰è£åˆ°ä¸»ç•«é¢</h3>
      <p class="text-zinc-400 text-sm mb-6">åœ¨ Safari ç€è¦½å™¨ä¸­é»æ“Š <strong>åˆ†äº«æŒ‰éˆ•</strong> ä¸¦é¸æ“‡ <strong>ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</strong> å³å¯å®‰è£ã€‚</p>
      <button id="ios-modal-close" class="w-full bg-blue-600 py-3 rounded-xl font-bold">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const icons = {
  X: () => <lucide.X size={24} />,
  Image: () => <lucide.Image size={24} />,
  Settings: () => <lucide.Settings size={24} />,
  Download: () => <lucide.Download size={20} />,
  Share: () => <lucide.Share size={20} />,
  RefreshCw: () => <lucide.RefreshCw size={20} className="animate-spin" />,
  Clipboard: () => <lucide.Clipboard size={20} />,
  Globe: () => <lucide.Globe size={14} />,
  MessageSquare: () => <lucide.MessageSquare size={14} />,
  Smile: () => <lucide.Smile size={14} />,
  Briefcase: () => <lucide.Briefcase size={14} />,
  Smartphone: () => <lucide.Smartphone size={20} />,
  Check: () => <lucide.Check size={20} />
};

const DEFAULT_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23333'%3E%3Crect width='24' height='24' fill='%23333'/%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z' fill='%23555'/%3E%3C/svg%3E";

function App() {
  const [tweetUrl, setTweetUrl] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [activeTab, setActiveTab] = useState("edit");
  const [isInstalled, setIsInstalled] = useState(false);
  
  const [config, setConfig] = useState({
    engine: "gemini",
    targetLang: "ZH-HANT",
    geminiKey: "",
    geminiModel: "gemini-2.0-flash",
    openRouterKey: "",
    openRouterModel: "xiaomi/mimo-v2-flash:free",
    displayMode: "bilingual",
    autoTranslate: false
  });
  
  const [tweet, setTweet] = useState({
    name: "X User",
    handle: "user",
    avatar: DEFAULT_AVATAR,
    content: "è²¼ä¸Šæ¨æ–‡é€£çµé–‹å§‹è£½ä½œå¡ç‰‡ã€‚",
    timestamp: new Date().toLocaleString(),
    stats: { replies: "12", retweets: "34", likes: "56", views: "1.2K" },
    image: "",
    translation: "",
    aiMode: ""
  });
  
  const cardRef = useRef(null);

  useEffect(() => {
    const saved = {};
    ["geminiKey", "openRouterKey", "autoTranslate", "engine", "targetLang", "displayMode", "openRouterModel"].forEach(k => {
      const v = localStorage.getItem(k);
      if (v !== null) saved[k] = k === "autoTranslate" ? v === "true" : v;
    });
    setConfig(prev => ({ ...prev, ...saved }));
    setIsInstalled(window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone);
  }, []);

  const handleFetch = async (url) => {
    setIsLoading(true);
    let handle = "user";
    try { handle = new URL(url).pathname.split("/")[1]; } catch(e){}
    
    try {
      const oembedUrl = `https://publish.twitter.com/oembed?url=${encodeURIComponent(url)}`;
      const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(oembedUrl)}`);
      const data = await res.json();
      const oembed = JSON.parse(data.contents);
      
      const div = document.createElement("div");
      div.innerHTML = oembed.html;
      const text = div.querySelector("p")?.innerText || "";
      
      setTweet(prev => ({
        ...prev,
        name: oembed.author_name,
        handle: handle,
        content: text,
        avatar: `https://unavatar.io/twitter/${handle}`,
        timestamp: new Date().toLocaleString()
      }));
      
      if (config.autoTranslate) triggerAI(text, "translate");
      else setActiveTab("preview");
    } catch (e) { alert("æŠ“å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€ã€‚"); }
    finally { setIsLoading(false); }
  };

  const triggerAI = async (text, action) => {
    if (!text) return;
    setIsLoading(true);
    setTweet(p => ({ ...p, translation: "", aiMode: "ğŸ”„ AI è™•ç†ä¸­..." }));
    
    try {
      const prompt = `Task: ${action} the following X/Twitter post into ${config.targetLang}. 
      Context: ${text}
      Instructions: Be natural, use internet slang appropriately. Output ONLY the result.`;
      
      let result = "";
      if (config.engine === "gemini") {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.geminiModel}:generateContent?key=${config.geminiKey}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await res.json();
        result = data.candidates[0].content.parts[0].text;
      } else {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: { "Authorization": `Bearer ${config.openRouterKey}`, "Content-Type": "application/json" },
          body: JSON.stringify({ model: config.openRouterModel, messages: [{ role: "user", content: prompt }] })
        });
        const data = await res.json();
        result = data.choices[0].message.content;
      }
      setTweet(p => ({ ...p, translation: result.trim(), aiMode: `âœ¨ AI ${action}` }));
    } catch (e) { alert("AI è«‹æ±‚å‡ºéŒ¯"); }
    finally { setIsLoading(false); setActiveTab("preview"); }
  };

  return (
    <div className="min-h-screen bg-black text-white font-sans">
      {isLoading && <div className="loading-overlay"><div className="loading-spinner"></div></div>}
      
      {activeTab === "edit" && (
        <div className="p-4 space-y-6 tab-content pb-32">
          <div className="bg-zinc-900 p-4 rounded-2xl border border-zinc-800 space-y-4">
            <h3 className="text-zinc-500 text-xs font-bold uppercase tracking-wider">è¼¸å…¥æ¨æ–‡é€£çµ</h3>
            <div className="flex gap-2">
              <input className="flex-1 bg-black border border-zinc-700 rounded-xl px-4 py-2 text-sm outline-none focus:border-blue-500" placeholder="https://x.com/..." value={tweetUrl} onChange={e=>setTweetUrl(e.target.value)} />
              <button onClick={()=>handleFetch(tweetUrl)} className="bg-blue-600 p-3 rounded-xl"><icons.Download /></button>
            </div>
          </div>

          <div className="space-y-4">
            <div className="flex gap-4 items-center">
              <img src={tweet.avatar} className="w-16 h-16 rounded-full border border-zinc-800 object-cover" />
              <div className="flex-1">
                <input className="w-full bg-transparent border-b border-zinc-800 py-1 font-bold" value={tweet.name} onChange={e=>setTweet({...tweet, name:e.target.value})} />
                <input className="w-full bg-transparent border-b border-zinc-800 py-1 text-zinc-500 text-sm" value={tweet.handle} onChange={e=>setTweet({...tweet, handle:e.target.value})} />
              </div>
            </div>
            <textarea className="w-full h-40 bg-zinc-900 border border-zinc-800 rounded-2xl p-4 text-lg outline-none resize-none" value={tweet.content} onChange={e=>setTweet({...tweet, content:e.target.value})} />
            
            <div className="grid grid-cols-2 gap-2">
              <button onClick={()=>triggerAI(tweet.content, "translate")} className="bg-zinc-900 p-3 rounded-xl flex items-center justify-center gap-2 text-blue-400 font-bold border border-zinc-800"><icons.Globe /> ç¿»è­¯</button>
              <button onClick={()=>triggerAI(tweet.content, "explain")} className="bg-zinc-900 p-3 rounded-xl flex items-center justify-center gap-2 text-purple-400 font-bold border border-zinc-800"><icons.MessageSquare /> è§£æ</button>
              <button onClick={()=>triggerAI(tweet.content, "funny rewrite")} className="bg-zinc-900 p-3 rounded-xl flex items-center justify-center gap-2 text-yellow-400 font-bold border border-zinc-800"><icons.Smile /> å¹½é»˜æ”¹å¯«</button>
              <button onClick={()=>triggerAI(tweet.content, "professional rewrite")} className="bg-zinc-900 p-3 rounded-xl flex items-center justify-center gap-2 text-green-400 font-bold border border-zinc-800"><icons.Briefcase /> å°ˆæ¥­æ”¹å¯«</button>
            </div>
          </div>
        </div>
      )}

      {activeTab === "preview" && (
        <div className="p-4 flex flex-col items-center tab-content pb-32">
          <div ref={cardRef} className="w-full max-w-[500px] bg-black p-6 border border-zinc-800">
            <div className="flex items-start mb-4">
              <img src={tweet.avatar} className="w-12 h-12 rounded-full mr-3 object-cover" />
              <div>
                <div className="font-bold text-base flex items-center gap-1">{tweet.name} <icons.Check className="text-blue-500 w-4 h-4" /></div>
                <div className="text-zinc-500 text-sm">@{tweet.handle}</div>
              </div>
            </div>
            <div className="text-[20px] leading-snug mb-4 whitespace-pre-wrap">{config.displayMode === "translationOnly" && tweet.translation ? tweet.translation : tweet.content}</div>
            {config.displayMode === "bilingual" && tweet.translation && (
              <div className="mt-4 pt-4 border-t border-dashed border-zinc-800">
                <div className="text-xs font-bold text-blue-400 mb-1">{tweet.aiMode}</div>
                <div className="text-[18px] text-zinc-200 whitespace-pre-wrap">{tweet.translation}</div>
              </div>
            )}
            <div className="py-4 border-t border-zinc-900 text-zinc-500 text-sm">{tweet.timestamp}</div>
            <div className="flex gap-4 text-zinc-500 text-sm pt-2">
              <span><strong>{tweet.stats.retweets}</strong> Reposts</span>
              <span><strong>{tweet.stats.likes}</strong> Likes</span>
            </div>
          </div>
          <div className="w-full max-w-[500px] mt-8 space-y-3">
            <button onClick={async ()=>{
              const canvas = await html2canvas(cardRef.current, { backgroundColor: "#000", scale: 2 });
              const link = document.createElement("a"); link.download="x-card.png"; link.href=canvas.toDataURL(); link.click();
            }} className="w-full bg-blue-600 py-4 rounded-full font-bold flex items-center justify-center gap-2"><icons.Download /> ä¸‹è¼‰ PNG</button>
          </div>
        </div>
      )}

      {activeTab === "settings" && (
        <div className="p-4 space-y-6 tab-content pb-32">
          <div className="bg-zinc-900 p-6 rounded-2xl border border-zinc-800 space-y-4">
            <label className="block text-sm font-bold text-zinc-500">ç¿»è­¯å¼•æ“</label>
            <div className="grid grid-cols-2 gap-2">
              <button onClick={()=>{setConfig({...config, engine:"gemini"}); localStorage.setItem("engine","gemini")}} className={`p-3 rounded-xl border font-bold ${config.engine==='gemini'?'border-blue-500 text-blue-400 bg-blue-500/10':'border-zinc-700'}`}>Gemini</button>
              <button onClick={()=>{setConfig({...config, engine:"openrouter"}); localStorage.setItem("engine","openrouter")}} className={`p-3 rounded-xl border font-bold ${config.engine==='openrouter'?'border-blue-500 text-blue-400 bg-blue-500/10':'border-zinc-700'}`}>OpenRouter</button>
            </div>
            <input type="password" placeholder="API Key" className="w-full bg-black border border-zinc-700 rounded-xl p-3 text-sm" value={config.engine==='gemini'?config.geminiKey:config.openRouterKey} onChange={e=>{
              const k = config.engine==='gemini'?'geminiKey':'openRouterKey';
              setConfig({...config, [k]: e.target.value}); localStorage.setItem(k, e.target.value);
            }} />
          </div>
        </div>
      )}

      <nav className="fixed bottom-0 w-full bg-zinc-900/80 backdrop-blur-lg border-t border-zinc-800 flex justify-around p-4 pb-10 z-50">
        <button onClick={()=>setActiveTab("edit")} className={activeTab==="edit"?"text-blue-500":"text-zinc-500"}><icons.X /><span className="text-[10px] block mt-1">ç·¨è¼¯</span></button>
        <button onClick={()=>setActiveTab("preview")} className={activeTab==="preview"?"text-blue-500":"text-zinc-500"}><icons.Image /><span className="text-[10px] block mt-1">é è¦½</span></button>
        <button onClick={()=>setActiveTab("settings")} className={activeTab==="settings"?"text-blue-500":"text-zinc-500"}><icons.Settings /><span className="text-[10px] block mt-1">è¨­å®š</span></button>
      </nav>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

// PWA Logic with relative path fix
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered')).catch(err => console.log('SW Failed', err));
  });
}
</script>
</body>
</html>
